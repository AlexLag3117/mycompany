MODULE ReceiptLot;

REQUIRE ProductLot, ReceiptSearch, ReceiptInv, InvLedgerLot;

NAMESPACE Inventory;

@defineDocLot (receipt, done, ' (принято)');

@defineDocBarCodeLot (receipt, done);

@defineDocDesignLot(receipt, done);

initialDemand 'Планируемое кол-во' = DATA NUMERIC[16,3] (ReceiptLine, Lot);
initialDemandLot 'Планируемое кол-во партии' (ReceiptLine rl) = GROUP SUM initialDemand(rl, Lot l);

EXTEND FORM receipt 
    PROPERTIES (l, lot) BEFORE done(l, lot) initialDemand READONLY
    PROPERTIES (lot) DELETE GRID
;

@defineLotCodeSearch(receipt, done);

processReceiptLot(STRING s) {
    IF NOT lot(s) THEN {
        NEW l = Lot {
            id(l) <- STRING[100](s);
        }
    }
}

processBarCode(Receipt r, STRING s) + {
    processReceiptLot(s);
}

processLotCode(Receipt r, STRING s) + {
    processReceiptLot(s);
}

//ledger
quantity(ReceiptInvLedger rl, Lot l) += done(line(rl), l);